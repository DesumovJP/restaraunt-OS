# Kitchen Timer Architecture

## Overview

This document describes the comprehensive timer tracking system for the Restaurant OS kitchen module. The system tracks multiple time phases for each order item, from the moment it enters the queue until it's served to the guest.

## Timer Phases

```
                                    LIFECYCLE OF AN ORDER ITEM

   ORDER       QUEUE        COOKING         READY         SERVED
   CREATED     WAITING      IN PROGRESS     WAITING       COMPLETED
      |           |             |              |              |
      v           v             v              v              v
   ---|-----------|-------------|--------------|--------------|---> time
      ^           ^             ^              ^              ^
      |           |             |              |              |
   createdAt   startedAt    completedAt    servedAt      (end)
                 (prepStart)  (readyAt)

   |<--queueMs-->|<--cookMs-->|<--pickupMs-->|
   |<-----------------totalMs---------------->|
```

### 1. Queue Time (`queueMs`)
- **Start**: `createdAt` - When order item is created and added to kitchen queue
- **End**: `startedAt` / `prepStartAt` - When chef starts cooking
- **Description**: Time the item spends waiting in the queue before cooking begins
- **Stored in**: Calculated from `startedAt - createdAt`

### 2. Cooking Time (`cookMs` / `prepElapsedMs`)
- **Start**: `startedAt` / `prepStartAt` - When chef clicks "Start"
- **End**: `completedAt` / `readyAt` - When chef clicks "Ready"
- **Description**: Active cooking/preparation time
- **Stored in**:
  - `order-item.prepElapsedMs` (biginteger, milliseconds)
  - `kitchen-ticket.elapsedSeconds` (integer, seconds)

### 3. Pickup Wait Time (`pickupMs`)
- **Start**: `completedAt` / `readyAt` - When dish is marked ready
- **End**: `servedAt` - When waiter clicks "Served"
- **Description**: Time the ready dish waits at the pass for pickup
- **Stored in**: Calculated from `servedAt - readyAt`
- **Display**: Timer continues counting UP from 0 when dish moves to "Ready" column

### 4. Total Time (`totalMs`)
- **Start**: `createdAt` - Order item creation
- **End**: `servedAt` - Item served to guest
- **Description**: Total time from order to service
- **Calculated**: `servedAt - createdAt`

## Data Models

### OrderItem (Strapi)

```typescript
interface OrderItem {
  // Existing fields
  documentId: string;
  order: Order;
  menuItem: MenuItem;
  quantity: number;
  unitPrice: number;
  totalPrice: number;
  status: 'draft' | 'queued' | 'pending' | 'in_progress' | 'ready' | 'served' | 'returned' | 'cancelled' | 'voided';
  statusChangedAt: Date;
  courseType: 'appetizer' | 'starter' | 'soup' | 'main' | 'dessert' | 'drink';
  notes: string;
  comment: ItemComment;
  modifiers: any[];

  // Timestamp fields for timer tracking
  createdAt: Date;          // Auto-generated by Strapi
  prepStartAt: Date;        // When chef started cooking
  prepElapsedMs: number;    // Cooking duration in ms
  readyAt: Date;            // NEW: When marked as ready
  servedAt: Date;           // When served to guest
  pickupWaitMs: number;     // NEW: Pickup wait duration in ms
}
```

### KitchenTicket (Strapi)

```typescript
interface KitchenTicket {
  documentId: string;
  ticketNumber: string;
  order: Order;
  orderItem: OrderItem;
  status: 'queued' | 'started' | 'paused' | 'resumed' | 'ready' | 'failed' | 'cancelled';
  station: 'grill' | 'fry' | 'salad' | 'hot' | 'dessert' | 'bar' | 'pass' | 'prep';
  priority: 'normal' | 'rush' | 'vip';
  priorityScore: number;
  assignedChef: User;

  // Timestamp fields
  createdAt: Date;          // Auto-generated - when queued
  startedAt: Date;          // When cooking started
  completedAt: Date;        // When cooking finished
  servedAt: Date;           // NEW: When served
  elapsedSeconds: number;   // Cooking time in seconds
  pickupWaitSeconds: number; // NEW: Pickup wait in seconds
}
```

### KitchenTask (Frontend Store)

```typescript
interface KitchenTask {
  documentId: string;
  orderItemDocumentId: string;
  orderDocumentId: string;
  menuItemName: string;
  quantity: number;
  tableNumber: number;
  tableOccupiedAt?: string;
  courseType: CourseType;
  status: StationSubTaskStatus;
  priority: 'normal' | 'rush' | 'vip';
  priorityScore: number;
  stationType: StationType;

  // Timer fields
  createdAt: string;        // When queued (ISO string)
  startedAt?: string;       // NEW: When cooking started
  readyAt?: string;         // NEW: When marked ready
  servedAt?: string;        // NEW: When served

  // Calculated durations (updated in real-time by UI)
  queueMs: number;          // NEW: Queue wait time
  cookMs: number;           // Cooking time (was elapsedMs)
  pickupMs: number;         // NEW: Pickup wait time
  totalMs: number;          // NEW: Total time

  // Target times
  targetCookMs: number;     // Expected cooking time (was targetCompletionMs)
  targetPickupMs: number;   // NEW: Expected pickup time (e.g., 2 minutes)

  // Status flags
  isOverdue: boolean;
  isPickupOverdue: boolean; // NEW: Pickup taking too long
  assignedChefName?: string;
  modifiers: string[];
  comment: ItemComment | null;
}
```

### Table Session Tracking

```typescript
interface Table {
  documentId: string;
  number: number;
  capacity: number;
  status: 'free' | 'occupied' | 'reserved';
  currentGuests?: number;
  reservedBy?: string;
  reservedAt?: Date;
  occupiedAt?: Date;        // Session start
  freedAt?: Date;           // NEW: Session end
  sessionDurationMs?: number; // NEW: Calculated total session time
  zone?: string;
}
```

## UI Timer Behavior

### 1. Queue Column (Pending)
- Timer shows: Time since `createdAt` (counting UP)
- Color:
  - Default: gray
  - Warning (>80% of expected): yellow
  - Overdue: red

### 2. Active Column (In Progress)
- Timer shows: Time since `startedAt` (counting UP from 0)
- Color:
  - Default: gray
  - Warning (>80% of `targetCookMs`): yellow
  - Overdue (> `targetCookMs`): red, card highlighted

### 3. Ready Column (Completed, waiting for pickup)
- Timer shows: Time since `readyAt` (counting UP from 0)
- Color:
  - Default: gray
  - Warning (>1 minute): yellow
  - Overdue (>2 minutes): red, card highlighted
- Action: "Served" button stops the timer

### 4. Served (After clicking "Served")
- Timer stops
- Final times are persisted to database
- Card is removed from view (or moved to history)

## API Endpoints

### Start Ticket
```
POST /api/kitchen-tickets/:documentId/start
```
Sets:
- `status: 'started'`
- `startedAt: now()`
- Updates related `order-item.prepStartAt`

### Complete Ticket (Ready)
```
POST /api/kitchen-tickets/:documentId/complete
```
Sets:
- `status: 'ready'`
- `completedAt: now()`
- `elapsedSeconds: (completedAt - startedAt) / 1000`
- Updates related `order-item.readyAt`, `order-item.prepElapsedMs`

### Serve Ticket (NEW)
```
POST /api/kitchen-tickets/:documentId/serve
```
Sets:
- `servedAt: now()`
- `pickupWaitSeconds: (servedAt - completedAt) / 1000`
- Updates related:
  - `order-item.servedAt`
  - `order-item.pickupWaitMs`
  - `order-item.status: 'served'`
- Triggers: Check if all items in order are served, update order status

## Events for Analytics

Each state transition emits an event for analytics:

```typescript
interface TimerEvent {
  type: 'item_queued' | 'item_started' | 'item_ready' | 'item_served';
  timestamp: Date;
  tableNumber: number;
  sessionId: string;
  orderDocumentId: string;
  orderItemDocumentId: string;
  ticketDocumentId: string;

  // Duration at this point
  queueMs?: number;      // For item_started
  cookMs?: number;       // For item_ready
  pickupMs?: number;     // For item_served
  totalMs?: number;      // For item_served

  // Context
  menuItemName: string;
  station: string;
  chefName?: string;
  wasOverdue: boolean;
  priority: string;
}
```

## Configuration

### Target Times (configurable per menu item or station)

```typescript
const DEFAULT_TARGET_TIMES = {
  // Cooking targets by station (minutes)
  cooking: {
    grill: 15,
    fry: 10,
    salad: 5,
    hot: 12,
    dessert: 8,
    bar: 3,
    prep: 5,
  },

  // Pickup wait thresholds (seconds)
  pickup: {
    warning: 60,   // 1 minute - show yellow
    overdue: 120,  // 2 minutes - show red
  },

  // Queue wait thresholds (minutes)
  queue: {
    warning: 5,    // 5 minutes - show yellow
    overdue: 10,   // 10 minutes - show red
  }
};
```

## Frontend Timer Updates

```typescript
// Timer update logic in kitchen UI
useEffect(() => {
  const interval = setInterval(() => {
    setTasks(prevTasks => prevTasks.map(task => {
      const now = Date.now();

      // Calculate current phase duration
      if (task.status === 'pending') {
        // Queue phase
        const queueMs = now - new Date(task.createdAt).getTime();
        return { ...task, queueMs };
      }

      if (task.status === 'in_progress') {
        // Cooking phase
        const startTime = new Date(task.startedAt!).getTime();
        const cookMs = now - startTime;
        const isOverdue = cookMs > task.targetCookMs;
        return { ...task, cookMs, isOverdue };
      }

      if (task.status === 'completed') {
        // Pickup wait phase
        const readyTime = new Date(task.readyAt!).getTime();
        const pickupMs = now - readyTime;
        const isPickupOverdue = pickupMs > DEFAULT_TARGET_TIMES.pickup.overdue * 1000;
        return { ...task, pickupMs, isPickupOverdue };
      }

      return task;
    }));
  }, 1000);

  return () => clearInterval(interval);
}, []);
```

## Database Schema Updates Required

### 1. order-item schema.json
Add fields:
```json
{
  "readyAt": {
    "type": "datetime"
  },
  "pickupWaitMs": {
    "type": "biginteger",
    "default": 0
  }
}
```

### 2. kitchen-ticket schema.json
Add fields:
```json
{
  "servedAt": {
    "type": "datetime"
  },
  "pickupWaitSeconds": {
    "type": "integer",
    "default": 0
  }
}
```

### 3. table schema.json
Add fields:
```json
{
  "freedAt": {
    "type": "datetime"
  },
  "lastSessionDurationMs": {
    "type": "biginteger"
  }
}
```

## Summary of Timer Flow

| Phase | Start Trigger | End Trigger | Duration Field | Display |
|-------|--------------|-------------|----------------|---------|
| Queue | Order created | Chef starts | queueMs | Time waiting |
| Cook | Chef starts | Chef marks ready | cookMs/prepElapsedMs | Cooking time |
| Pickup | Marked ready | Waiter serves | pickupMs | Wait for pickup |
| Total | Order created | Served | totalMs | Full lifecycle |

## Visual Indicators

| Timer State | Text Color | Background | Border |
|-------------|------------|------------|--------|
| Normal | gray | none | none |
| Warning (80%) | yellow/orange | light yellow | yellow |
| Overdue | red, bold | light red | red ring |

## Implementation Priority

1. **Phase 1**: Add missing fields to schemas (readyAt, pickupWaitMs, servedAt, etc.)
2. **Phase 2**: Update backend controllers to set timestamps on state transitions
3. **Phase 3**: Update frontend KitchenTask to include new timer fields
4. **Phase 4**: Update UI components to display phase-specific timers
5. **Phase 5**: Add analytics events for reporting
