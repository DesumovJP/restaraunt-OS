# Архітектура системи Столів та Замовлень

## 1. Огляд

Система управління столами та замовленнями забезпечує повний цикл обслуговування гостей:
- Управління столами (зайняття, об'єднання, переміщення)
- Створення та модифікація замовлень
- Взаємодія з кухнею
- Закриття та оплата

---

## 2. Структура даних

### 2.1 Стіл (Table)

```typescript
interface Table {
  documentId: string;
  number: number;                    // Номер столу (унікальний)
  status: TableStatus;               // Статус столу
  capacity: number;                  // Місткість (за замовчуванням 4)
  currentGuests: number | null;      // Поточна кількість гостей
  zone: string;                      // Зона: main, terrace, vip, bar
  isActive: boolean;                 // Чи активний стіл

  // Сесія
  occupiedAt: DateTime | null;       // Час зайняття
  freedAt: DateTime | null;          // Час звільнення
  lastSessionDurationMs: bigint;     // Тривалість останньої сесії

  // Бронювання
  reservedBy: string | null;         // Ім'я для бронювання
  reservedAt: DateTime | null;       // Час бронювання
  reservationId: string | null;      // Зв'язок з бронюванням

  // Об'єднання столів
  mergedWith: string[];              // IDs об'єднаних столів
  primaryTableId: string | null;     // ID головного столу (якщо цей об'єднаний)

  // Закриття
  lastCloseReason: CloseReason;
  closeComment: string | null;
}

type TableStatus = 'free' | 'occupied' | 'reserved' | 'billing';

type CloseReason =
  | 'normal'           // Звичайне закриття
  | 'mistaken_open'    // Помилково відкрито
  | 'no_show'          // Гість не прийшов
  | 'walkout'          // Пішов без оплати
  | 'emergency'        // Екстрене закриття
  | 'technical_error'; // Технічна помилка
```

### 2.2 Замовлення (Order)

```typescript
interface Order {
  documentId: string;
  orderNumber: string;               // Унікальний номер замовлення
  table: Table;                      // Зв'язок зі столом
  status: OrderStatus;               // Статус замовлення

  // Фінанси
  totalAmount: decimal;              // Загальна сума
  taxAmount: decimal;                // Сума податку
  tipAmount: decimal;                // Чайові

  // Персонал
  waiter: User;                      // Офіціант

  // Час
  createdAt: DateTime;
  tableStartAt: DateTime;            // Початок сесії столу
  paidAt: DateTime | null;           // Час оплати

  // Оплата
  paymentMethod: PaymentMethod | null;

  // Версіонування (для concurrent edit detection)
  version: number;                   // Версія для оптимістичного блокування

  // Зв'язки
  items: OrderItem[];
  tickets: KitchenTicket[];
}

type OrderStatus =
  | 'new'        // Нове замовлення
  | 'confirmed'  // Підтверджено
  | 'in_kitchen' // На кухні
  | 'ready'      // Готове
  | 'served'     // Подано
  | 'cancelled'  // Скасовано
  | 'paid';      // Оплачено

type PaymentMethod = 'cash' | 'card' | 'paylater';
```

### 2.3 Позиція замовлення (OrderItem)

```typescript
interface OrderItem {
  documentId: string;
  order: Order;
  menuItem: MenuItem;

  quantity: number;
  unitPrice: decimal;
  totalPrice: decimal;

  status: OrderItemStatus;
  statusChangedAt: DateTime;

  // Курс (порядок подачі)
  courseType: CourseType;
  courseIndex: number;

  // Коментарі
  notes: string;
  comment: JSON;

  // Таймінги
  prepStartAt: DateTime | null;
  prepElapsedMs: bigint;
  readyAt: DateTime | null;
  servedAt: DateTime | null;
  pickupWaitMs: bigint;

  // Модифікатори
  modifiers: JSON;
}

type OrderItemStatus =
  | 'draft'       // Чернетка
  | 'queued'      // В черзі
  | 'pending'     // Очікує
  | 'in_progress' // Готується
  | 'ready'       // Готово
  | 'served'      // Подано
  | 'returned'    // Повернено
  | 'cancelled'   // Скасовано
  | 'voided';     // Анульовано

type CourseType =
  | 'appetizer'   // Закуска
  | 'starter'     // Перша страва
  | 'soup'        // Суп
  | 'main'        // Основна страва
  | 'dessert'     // Десерт
  | 'drink';      // Напій
```

---

## 3. Діаграми потоків

### 3.1 Життєвий цикл столу

```
                    ┌──────────────┐
                    │    FREE      │
                    │   (вільний)  │
                    └──────┬───────┘
                           │
           ┌───────────────┼───────────────┐
           │               │               │
           ▼               ▼               │
    ┌──────────────┐ ┌──────────────┐      │
    │   RESERVED   │ │   OCCUPIED   │      │
    │ (заброньов.) │ │   (зайнятий) │      │
    └──────┬───────┘ └──────┬───────┘      │
           │               │               │
           │    ┌──────────┘               │
           │    │                          │
           ▼    ▼                          │
    ┌──────────────┐                       │
    │   OCCUPIED   │                       │
    │   (зайнятий) │                       │
    └──────┬───────┘                       │
           │                               │
           ▼                               │
    ┌──────────────┐                       │
    │   BILLING    │ ◄── Новий статус      │
    │  (розрахунок)│                       │
    └──────┬───────┘                       │
           │                               │
           └───────────────────────────────┘
```

### 3.2 Життєвий цикл замовлення

```
┌─────────┐     ┌───────────┐     ┌────────────┐
│   NEW   │ ──► │ CONFIRMED │ ──► │ IN_KITCHEN │
└─────────┘     └───────────┘     └─────┬──────┘
                                        │
                                        ▼
┌─────────┐     ┌───────────┐     ┌────────────┐
│  PAID   │ ◄── │  SERVED   │ ◄── │   READY    │
└─────────┘     └───────────┘     └────────────┘
     │
     │          ┌───────────┐
     └─────────►│ CANCELLED │ (можливо з будь-якого статусу)
                └───────────┘
```

### 3.3 Життєвий цикл позиції замовлення

```
┌───────┐    ┌────────┐    ┌─────────┐    ┌─────────────┐
│ DRAFT │ ─► │ QUEUED │ ─► │ PENDING │ ─► │ IN_PROGRESS │
└───────┘    └────────┘    └─────────┘    └──────┬──────┘
                                                 │
                                                 ▼
┌──────────┐    ┌────────┐    ┌───────┐    ┌─────────┐
│ RETURNED │ ◄─ │ SERVED │ ◄─ │ READY │ ◄──┤         │
└────┬─────┘    └────────┘    └───────┘    └─────────┘
     │                             │
     └────────────► QUEUED ◄───────┘ (повторна готовка)

┌───────────┐    ┌────────┐
│ CANCELLED │    │ VOIDED │  (термінальні стани)
└───────────┘    └────────┘
```

---

## 4. API Endpoints

### 4.1 Управління столами

| Метод | Endpoint | Опис |
|-------|----------|------|
| GET | `/api/tables` | Отримати всі столи |
| GET | `/api/tables/:id` | Отримати стіл за ID |
| PUT | `/api/tables/:id` | Оновити стіл |
| POST | `/api/tables/:id/occupy` | Зайняти стіл |
| POST | `/api/tables/:id/close` | Закрити стіл (оплата) |
| POST | `/api/tables/:id/emergency-close` | Екстрене закриття |
| POST | `/api/tables/:id/merge` | Об'єднати столи |
| DELETE | `/api/tables/:id/merge` | Роз'єднати столи |
| POST | `/api/tables/:id/transfer` | Перенести гостей |

### 4.2 Управління замовленнями

| Метод | Endpoint | Опис |
|-------|----------|------|
| GET | `/api/orders` | Отримати замовлення |
| POST | `/api/orders` | Створити замовлення |
| PUT | `/api/orders/:id` | Оновити замовлення |
| POST | `/api/orders/:id/items` | Додати страви до існуючого |
| PUT | `/api/orders/:id/items/:itemId` | Змінити страву |
| DELETE | `/api/orders/:id/items/:itemId` | Видалити страву |
| POST | `/api/orders/:id/transfer` | Перенести на інший стіл |

### 4.3 Кухонні тікети

| Метод | Endpoint | Опис |
|-------|----------|------|
| POST | `/api/kitchen-tickets/:id/start` | Почати готувати |
| POST | `/api/kitchen-tickets/:id/complete` | Завершити |
| POST | `/api/kitchen-tickets/:id/pause` | Пауза |
| POST | `/api/kitchen-tickets/:id/resume` | Продовжити |
| POST | `/api/kitchen-tickets/:id/cancel` | Скасувати |
| POST | `/api/kitchen-tickets/:id/fail` | Позначити як невдале |
| POST | `/api/kitchen-tickets/:id/serve` | Подати |
| POST | `/api/kitchen-tickets/:id/recall` | Відкликати з кухні |

---

## 5. Нові функції

### 5.1 Об'єднання столів (Table Merge)

**Мета:** Дозволити офіціанту об'єднати кілька столів для великої компанії.

**Потік:**
```
1. Офіціант обирає головний стіл
2. Обирає столи для об'єднання
3. POST /api/tables/:primaryId/merge { tableIds: [...] }
4. Всі столи позначаються як об'єднані
5. Замовлення прив'язуються до головного столу
6. При закритті - закриваються всі об'єднані столи
```

**Правила:**
- Можна об'єднувати тільки `free` або `occupied` столи
- Головний стіл зберігає всі замовлення
- При роз'єднанні - вторинні столи стають `free`

### 5.2 Додавання страв до існуючого замовлення

**Мета:** Дозволити офіціанту додати страви після відправки замовлення на кухню.

**Потік:**
```
1. Офіціант обирає активне замовлення
2. Додає нові страви
3. POST /api/orders/:id/items { items: [...] }
4. Створюються нові OrderItem + KitchenTicket
5. Кухня отримує нові тікети
```

**Правила:**
- Можна додавати до замовлень зі статусом: `confirmed`, `in_kitchen`, `ready`
- Не можна додавати до `served`, `paid`, `cancelled`
- Нові страви отримують наступний courseIndex

### 5.3 Екстрене закриття столу

**Мета:** Закрити стіл навіть якщо є неподані страви (walkout, emergency).

**Потік:**
```
1. Офіціант/менеджер обирає "Екстрене закриття"
2. Вказує причину (walkout, emergency, etc.)
3. POST /api/tables/:id/emergency-close { reason, comment }
4. Всі неподані страви позначаються як 'abandoned'
5. Стіл закривається з відповідним логом
```

**Правила:**
- Потребує підтвердження
- Логується з severity: `warning`
- Не впливає на revenue (abandoned items не рахуються)

### 5.4 Переміщення гостей між столами

**Мета:** Перенести гостей та їх замовлення на інший стіл.

**Потік:**
```
1. Офіціант обирає стіл-джерело
2. Обирає стіл-призначення
3. POST /api/tables/:sourceId/transfer { targetTableId }
4. Замовлення переносяться на новий стіл
5. Старий стіл стає `free`
6. Новий стіл стає `occupied`
```

**Правила:**
- Стіл-призначення має бути `free`
- Переносяться всі активні замовлення
- Час сесії зберігається (occupiedAt не змінюється)

### 5.5 Автоматичний зв'язок бронювання → стіл

**Мета:** При створенні бронювання автоматично резервувати стіл.

**Потік:**
```
Reservation Created (lifecycle hook)
  ↓
Знайти вказаний стіл
  ↓
Перевірити: стіл free?
  ↓ ТАК
Оновити стіл: status='reserved', reservationId=...
  ↓
При прибутті гостя: status='occupied'
```

**Правила:**
- Бронювання за 2+ години до часу не резервує стіл одразу
- Резервування відбувається за 30 хвилин до часу
- При скасуванні бронювання - стіл стає `free`

### 5.6 Відкликання замовлення з кухні

**Мета:** Скасувати тікет що вже готується.

**Потік:**
```
1. Офіціант обирає страву
2. Натискає "Відкликати"
3. POST /api/kitchen-tickets/:id/recall { reason }
4. Тікет скасовується
5. Інвентар повертається (якщо був списаний)
6. OrderItem позначається як 'cancelled'
```

**Правила:**
- Можна відкликати тільки `queued`, `pending`, `in_progress` тікети
- Не можна відкликати `ready`, `served`, `failed`
- Потребує причину для логування

---

## 6. Обробка помилок та Edge Cases

### 6.1 Concurrent Edit Detection (Оптимістичне блокування)

**Проблема:** Два офіціанти одночасно редагують одне замовлення.

**Рішення:**
```typescript
// При оновленні замовлення:
const order = await findOrder(id);
if (order.version !== requestVersion) {
  throw new ConflictError('Замовлення було змінено іншим користувачем');
}
order.version += 1;
await order.save();
```

**Frontend:**
- Показувати повідомлення про конфлікт
- Пропонувати перезавантажити дані

### 6.2 Walkout (Гість пішов без оплати)

**Обробка:**
1. Офіціант викликає "Екстрене закриття" з причиною `walkout`
2. Всі неоплачені замовлення позначаються спеціальним тегом
3. Логується для аудиту
4. Можливе створення "боргового" запису

### 6.3 Відмова від страви після подачі

**Обробка:**
1. Офіціант використовує "Undo" систему
2. Страва повертається на статус `returned`
3. Може бути перенаправлена на перепридготування
4. Логується причина повернення

---

## 7. Інтеграція з іншими системами

### 7.1 Pusher (Real-time)

**Події:**
| Подія | Канал | Опис |
|-------|-------|------|
| `table.occupied` | `tables` | Стіл зайнято |
| `table.freed` | `tables` | Стіл звільнено |
| `table.merged` | `tables` | Столи об'єднано |
| `order.created` | `orders` | Нове замовлення |
| `order.ready` | `orders` | Замовлення готове |
| `order.served` | `orders` | Замовлення подано |
| `ticket.ready` | `kitchen` | Тікет готовий |

### 7.2 Action History (Логування)

**Логуються:**
- Всі зміни статусу столу
- Створення/модифікація/скасування замовлень
- Екстрені закриття
- Об'єднання/роз'єднання столів
- Переміщення гостей

---

## 8. Безпека та авторизація

### 8.1 Ролі та дозволи

| Дія | Офіціант | Менеджер | Адмін |
|-----|----------|----------|-------|
| Зайняти стіл | ✅ | ✅ | ✅ |
| Закрити стіл | ✅ | ✅ | ✅ |
| Екстрене закриття | ❌ | ✅ | ✅ |
| Об'єднати столи | ✅ | ✅ | ✅ |
| Переміщення гостей | ✅ | ✅ | ✅ |
| Void після подачі | ❌ | ✅ | ✅ |
| Перегляд звітів | ❌ | ✅ | ✅ |

---

## 9. Метрики та аналітика

### 9.1 Метрики столу
- Середній час сесії
- Оборот столу (сесій на день)
- Revenue per minute
- Середній чек

### 9.2 Метрики замовлення
- Час від створення до готовності
- Час від готовності до подачі
- Кількість скасувань
- Середня кількість страв

### 9.3 Метрики офіціанта
- Кількість закритих столів
- Загальний revenue
- Середні чайові
- Кількість void/cancel

---

## 10. Статус імплементації

### 10.1 Backend API (Реалізовано)

| Функція | Endpoint | Статус |
|---------|----------|--------|
| Закриття столу | `POST /api/tables/:id/close` | ✅ |
| Екстрене закриття | `POST /api/tables/:id/emergency-close` | ✅ |
| Об'єднання столів | `POST /api/tables/:id/merge` | ✅ |
| Роз'єднання столів | `DELETE /api/tables/:id/merge` | ✅ |
| Переміщення гостей | `POST /api/tables/:id/transfer` | ✅ |
| Додати страви до замовлення | `POST /api/orders/:id/items` | ✅ |
| Відкликати з кухні | `POST /api/kitchen-tickets/:id/recall` | ✅ |

### 10.2 Автоматизація (Реалізовано)

| Функція | Опис | Статус |
|---------|------|--------|
| Бронювання → Стіл | При підтвердженні бронювання стіл автоматично резервується | ✅ |
| Прибуття гостей | При статусі `seated` стіл стає `occupied` | ✅ |
| Скасування | При скасуванні бронювання стіл звільняється | ✅ |
| Оптимістичне блокування | `version` поле в Order для conflict detection | ✅ |

### 10.3 Схеми даних (Оновлено)

**Table Schema**:
- Додано: `billing` статус
- Додано: `emergency` причина закриття
- Додано: `mergedWith` (JSON array)
- Додано: `primaryTableId` (string)
- Додано: `reservation` (relation)

**Order Schema**:
- Додано: `version` (integer) для оптимістичного блокування

### 10.4 Frontend (Очікує)

Необхідно оновити фронтенд для підтримки нових функцій:
- UI для об'єднання столів
- UI для екстреного закриття
- UI для переміщення гостей
- UI для додавання страв до існуючих замовлень
- UI для відкликання з кухні
- Обробка конфліктів версій

---

*Документ створено: 2026-01-16*
*Оновлено: 2026-01-16*
*Версія: 1.1*
